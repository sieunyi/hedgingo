{% extends "global/Page.html" %}
{% load otree static %}

{% block title %}
    Round {{ round_number }} of {{ num_rounds }}
{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center mb-4">
        <div class="col-md-12">
            <p>Por favor, seleccione cuánto desea asignar de sus activos a la Lotería 1. La porción restante se asignará automáticamente a la Lotería 2.</p>
            <ul>
                <li>Lotería 1: Con probabilidad {{ p }}, usted obtiene {{ x1_l }}, y con probabilidad {{ one_minus_p }}, obtiene {{ x1_h }}.</li>
                <li>Lotería 2: Con probabilidad {{ p }}, usted obtiene {{ x2_h }}, y con probabilidad {{ one_minus_p }}, obtiene {{ x2_l }}.</li>
            </ul>
        </div>
    </div>

    <div class="row justify-content-cente§§§r">
        <div class="col-md-4">
            <canvas id="l1_graph" style="height: 300px; width: 80%; max-width: 300px;"></canvas>
        </div>
<div class="col-md-4 d-flex flex-column justify-content-center">
    <label for="alpha_slider">Elija tu porción de inversión en Lotería 1. </label>
    <input type="range" min="0" max="1" step="0.1" id="alpha_slider" value="0.5" oninput="updateAlphaFromSlider(this.value)" style="width: 100%;">
    <div class="d-flex justify-content-between mt-2" style="font-size: 0.8em;">
        <span>0</span>
        <span>0.1</span>
        <span>0.2</span>
        <span>0.3</span>
        <span>0.4</span>
        <span>0.5</span>
        <span>0.6</span>
        <span>0.7</span>
        <span>0.8</span>
        <span>0.9</span>
        <span>1</span>
    </div>
    <div class="mt-3">
        <input type="number" id="alpha_input" min="0" max="1" step="0.1" ; oninput="validateAlpha()">
    </div>
        <input type="hidden" name="alpha" id="id_alpha" value="0.5">

</div>


        <div class="col-md-4">
            <canvas id="l2_graph" style="height: 300px; width: 80%; max-width: 300px;"></canvas>
        </div>
    </div>

    <div class="row justify-content-center mt-4">
        <div class="col-md-5">
            <canvas id="probability_pie" style="height: 300px;"></canvas>
        </div>
        <div class="col-md-5">
            <canvas id="ev_graphs" style="height: 300px;"></canvas>
        </div>
    </div>
</div>

{% next_button %}
{% endblock %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script>
    Chart.register(ChartDataLabels);
    var softBlue = '#4682B4';
    var mutedOrange = '#D2691E';

   function updateAlphaFromSlider(value) {
        var roundedValue = parseFloat(value).toFixed(1);
        document.getElementById('alpha_slider').value = roundedValue;
        document.getElementById('id_alpha').value = roundedValue;
        document.getElementById('alpha_input').value = roundedValue;
        updateEVGraphs(parseFloat(roundedValue));
        validateAlpha();
    }

 function validateAlpha() {
    var sliderValue = parseFloat(document.getElementById('alpha_slider').value);
    var inputValue = parseFloat(document.getElementById('alpha_input').value || 0);
    var errorMessage = document.getElementById('error_message');

    if (Math.abs(sliderValue - inputValue) > 0.001) {
        errorMessage.style.display = 'block';
    } else {
        errorMessage.style.display = 'none';
        document.getElementById('id_alpha').value = sliderValue.toFixed(1);
    }
}
    var alphaSlider = document.getElementById('alpha_slider');
    var alphaInput = document.getElementById('alpha_input');
    var hiddenAlphaInput = document.getElementById('id_alpha');
    alphaSlider.value = 0.5;
    alphaInput.value = '';
    hiddenAlphaInput.value = 0.5;
    hiddenAlphaInput.style.display = 'none';

    function createChart(ctx, type, data, options) {
        return new Chart(ctx, {
            type: type,
            data: data,
            options: Object.assign({
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        color: '#000',
                        font: {
                            weight: 'bold'
                        },
                        formatter: function(value) {
                            return parseFloat(value).toFixed(2);
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            callback: function(value, index) {
                                return index === 0 ? 'p' : '1-p';
                            }
                        }
                    }
                }
            }, options)
        });
    }

    var minValue = Math.min({{ x1_l }}, {{ x1_h }}, {{ x2_l }}, {{ x2_h }});
    var maxValue = Math.max({{ x1_l }}, {{ x1_h }}, {{ x2_l }}, {{ x2_h }});

    var l1_chart = createChart(document.getElementById('l1_graph').getContext('2d'), 'bar', {
        labels: ['p', '1-p'],
        datasets: [{
            data: [{{ x1_l }}, {{ x1_h }}],
            backgroundColor: [softBlue, mutedOrange],
            barPercentage: 0.5,
            categoryPercentage: 1.0
        }]
    }, {
        plugins: {
            title: { display: true, text: 'Lotería 1' },
            legend: { display: false, position: 'bottom' },

            datalabels: {
                anchor: 'end',
                align: 'top',
            }
        },
        scales: {
            y: { min: minValue, max: maxValue }
        }
    });

    var l2_chart = createChart(document.getElementById('l2_graph').getContext('2d'), 'bar', {
        labels: ['p', '1-p'],
        datasets: [{
            data: [{{ x2_h }}, {{ x2_l }}],
            backgroundColor: [softBlue, mutedOrange],
            barPercentage: 0.5,
            categoryPercentage: 1.0
        }]
    }, {
        plugins: {
            title: { display: true, text: 'Lotería 2' },
            legend: { display: false, position: 'bottom' },

            datalabels: {
                anchor: 'end',
                align: 'top',
            }
        },
        scales: {
            y: { min: minValue, max: maxValue }
        }
    });

    var pie_chart = createChart(document.getElementById('probability_pie').getContext('2d'), 'pie', {
        labels: ['p', '1-p'],
        datasets: [{
            data: [{{ p }}, {{ one_minus_p }}],
            backgroundColor: [softBlue, mutedOrange],
            borderWidth: 0
        }]
    }, {
        plugins: {
            title: { display: true, text: 'Distribución de Probabilidad' },
            legend: { display: false, position: 'bottom' },
            datalabels: {
                color: '#fff',
                font: {
                    weight: 'bold'
                },
                formatter: function(value, context) {
                    return context.chart.data.labels[context.dataIndex] + ': ' + parseFloat(value).toFixed(2);
                }
            }
        }
    });

    var ev_chart = createChart(document.getElementById('ev_graphs').getContext('2d'), 'bar', {
        labels: ['p', '1-p'],
        datasets: [{
            data: [0, 0],
            backgroundColor: [softBlue, mutedOrange],
            barPercentage: 0.5,
            categoryPercentage: 1.0
        }]
    }, {
        plugins: {
            title: { display: true, text: 'Valores Esperados' },
            legend: { display: false, text: 'Valores Esperados' },

            datalabels: {
                anchor: 'end',
                align: 'top',
            }
        },
        scales: {
            y: { min: minValue, max: maxValue }
        }
    });

    function updateEVGraphs(alpha) {
        var ev_down = (alpha * {{ x1_l }} + (1 - alpha) * {{ x2_h }}).toFixed(2);
        var ev_up = (alpha * {{ x1_h }} + (1 - alpha) * {{ x2_l }}).toFixed(2);
        ev_chart.data.datasets[0].data = [parseFloat(ev_down), parseFloat(ev_up)];
        ev_chart.update();
    }

    updateEVGraphs(0.5);

    // Update alpha slider to round to one decimal place
    var alphaSlider = document.getElementById('alpha_slider');
    alphaSlider.addEventListener('input', function() {
        var roundedValue = parseFloat(this.value).toFixed(1);
        this.value = roundedValue;
        updateAlpha(roundedValue);
    });

    alphaSlider.addEventListener('input', function() {
        updateAlphaFromSlider(this.value);
    });
    alphaInput.addEventListener('input', function() {
    validateAlpha();
});
    // Form submission handler
    document.querySelector('form').addEventListener('submit', function(event) {
        if (!validateAlpha()) {
            event.preventDefault();
        }
    });
</script>
{% endblock %}